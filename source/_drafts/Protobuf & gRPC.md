---
date: 2020-09-15 14:54:19.363229
title: Protobuf & gRPC
---
# Protobuf & gRPC

è¿™ç¯‡æ–‡ç« å†™çš„å¾ˆä¹±ï¼Œå› ä¸ºæ€è·¯æœ‰å¤§æ–­æµã€‚æœ¬æ–‡å†æ—¶å¾ˆå¤šå¤©ï¼ŒæœŸé—´æˆ‘çš„ä¸¤å¤§ä¸»è¦å¼€å‘ç¯å¢ƒ Python å’Œ Golang ä»¥åŠåŒ…ç®¡ç†å·¥å…· Homebrew éƒ½ç‚¸äº†ï¼ˆå› ä¸ºä¸€æ¡æ²¡ç»è¿‡æ·±æ€çš„é”™è¯¯çš„ `brew upgrade` å‘½ä»¤ï¼‰ã€‚å°è¯•æ‰‹åŠ¨ä¿®å¤ï¼Œæäº†ä¸€å¤©ï¼Œæ— æœã€‚æ²¡åŠæ³•å°± Time Machine æ¢å¤äº†ä¸€ä¸‹ï¼Œç”±äºæœ€è¿‘æ²¡å¤‡ä»½ğŸ˜­ï¼Œä¸€ä¸‹å­å›åˆ°äº†åå¤©å‰ã€‚å„ç§æ‰‹åŠ¨æ£€æŸ¥ã€git pullï¼ŒåˆèŠ±è´¹äº†ä¸€å¤©ã€‚ã€‚ã€‚

ä¸ç®¡æ€æ ·ï¼Œè¿™ç¯‡æ–‡ç« å‰åŠéƒ¨åˆ†ä»‹ç»äº† Protocol Buffers çš„åŸºæœ¬è¯­æ³•ä»¥åŠå¦‚ä½•å®‰è£…ä½¿ç”¨ã€‚ååŠéƒ¨åˆ†ä»‹ç»äº†åŸºæœ¬çš„ gRPC å…¥é—¨ã€‚

## Protobuf

> [Protocol Buffers](https://developers.google.com/protocol-buffers) æ˜¯ä¸€ç§åºåˆ—åŒ–æ•°æ®ç»“æ„çš„åè®®ã€‚å¯¹äºé€è¿‡ç®¡é“æˆ–å­˜å‚¨æ•°æ®è¿›è¡Œé€šä¿¡çš„ç¨‹åºå¼€å‘ä¸Šæ˜¯å¾ˆæœ‰ç”¨çš„ã€‚è¿™ä¸ªæ–¹æ³•åŒ…å«ä¸€ä¸ªæ¥å£æè¿°è¯­è¨€ï¼Œæè¿°ä¸€äº›æ•°æ®ç»“æ„ï¼Œå¹¶æä¾›ç¨‹åºå·¥å…·æ ¹æ®è¿™äº›æè¿°äº§ç”Ÿä»£ç ï¼Œç”¨äºå°†è¿™äº›æ•°æ®ç»“æ„äº§ç”Ÿæˆ–è§£ææ•°æ®æµã€‚
>
> â€”â€”  [WikiPedia](https://zh.wikipedia.org/zh-cn/Protocol_Buffers)

æ€»è€Œè¨€ä¹‹ï¼Œ [Protocol Buffers](https://developers.google.com/protocol-buffers)ï¼Œç®€ç§° Protobufï¼Œ æ˜¯ä¸€ç§æ•°æ®æè¿°è¯­è¨€ï¼ˆå’Œ XMLã€JSON è¿™äº›ç±»ä¼¼ï¼‰ã€‚Protobuf é…å¥—çš„å·¥å…·å¯ä»¥è‡ªåŠ¨ç”Ÿæˆå°†å„ç§è¯­è¨€ä¸­çš„æ•°æ®ç»“æ„åºåˆ—åŒ–ä¸º Protobuf è¡¨ç¤ºï¼Œç„¶åååºåˆ—åŒ–åˆ°ä»»æ„æ”¯æŒçš„è¯­è¨€ä¸­ã€‚

åœ¨ RPC ä¸­ï¼Œè·¨è¯­è¨€çš„æ•°æ®ç¼–ç ã€è§£ç æ˜¯ä¸ªé—®é¢˜ï¼Œ Protobuf æ˜¯ä¸€ç§æ¯”è¾ƒé«˜æ•ˆçš„è§£å†³æ–¹æ¡ˆã€‚gRPC å°±æ˜¯åŸºäº Protobuf çš„ã€‚

### å®‰è£… Protobuf

åœ¨ macOS ä¸Šï¼Œä½¿ç”¨  homebrew å¯ä»¥å¿«é€Ÿå®‰è£… protobufã€‚ `brew` ç»å¯¹æ˜¯æˆ‘è§è¿‡æœ€çœäº‹çš„åŒ…ç®¡ç†ï¼Œå¿½ç•¥å›½å†…ä¼—æ‰€å‘¨çŸ¥çš„åŸå› å¸¦æ¥çš„ä¸€äº›å°é—®é¢˜ï¼Œå‡ ä¹æ»¡è¶³äº†ä¸€åˆ‡æ—¥å¸¸å®‰è£…éœ€è¦ï¼š

```sh
$ brew install protobuf
...
$ protoc --version
libprotoc 3.13.0
```

æˆ‘ä»¬è¦åœ¨ Golang ä¸­ä½¿ç”¨ protobufï¼Œéœ€è¦æŠŠ ptotobuf â€œç¼–è¯‘â€æˆ Golangï¼Œéœ€è¦å®‰è£…  protoc-gen-go å·¥å…·æ¥åšè¿™ä»¶äº‹ï¼š

```sh
$ go install google.golang.org/protobuf/cmd/protoc-gen-go
```

ä¸‹é¢å…ˆå°è¯•ä½¿ç”¨å®ƒå®Œæˆä¸€æ¬¡ HelloWorldï¼Œåé¢å†ä»‹ç» Protobuf çš„åŸºæœ¬è¯­æ³•å‘€ã€‚

### ä½¿ç”¨ Protobuf

é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ª `hello.proto` æ–‡ä»¶ï¼š

```sh
$ vim hello.proto
```

å†™å…¥å¦‚ä¸‹ Protocol Buffers ä»£ç ï¼š

```protobuf
syntax =  "proto3";

package hello;

message Hello {
	string world = 1;
	int32 meaningless_count = 2;
}
```

ç¼–è¯‘ï¼Œç”Ÿæˆ Golang ä»£ç ï¼š

```sh
$ protoc --go_out=. hello.proto
```

`go_out` å‘Šè¯‰ protoc ç¼–è¯‘å™¨åŠ è½½ protoc-gen-go å·¥å…·æ¥ç”Ÿæˆä»£ç ï¼ŒæŠŠç”Ÿæˆä»£ç æ”¾åˆ°å½“å‰ç›®å½•ã€‚å¿½ç•¥æ‰“å°çš„ WARNINGï¼Œ`protoc` åœ¨å½“å‰è·¯å¾„ä¸‹ç”Ÿæˆäº†ä¸€ä¸ª `hello.pb.go` çš„æ–‡ä»¶ã€‚é‡Œé¢æœ‰å¾ˆå¤šå†…å®¹ï¼ŒåŒ…æ‹¬ï¼š

```go
// Code generated by protoc-gen-go. DO NOT EDIT.
// versions:
// 	protoc-gen-go v1.25.0
// 	protoc        v3.13.0
// source: hello.proto

package hello

type Hello struct {
    ...

	World            string `protobuf:"bytes,1,opt,name=world,proto3" json:"world,omitempty"`
	MeaninglessCount int32  `protobuf:"varint,2,opt,name=meaningless_count,json=meaninglessCount,proto3" json:"meaningless_count,omitempty"`
}

func (x *Hello) Reset() {...}
func (x *Hello) String() string {...}
func (*Hello) ProtoMessage() {}
func (x *Hello) ProtoReflect() protoreflect.Message {...}
func (*Hello) Descriptor() ([]byte, []int) {...}
func (x *Hello) GetWorld() string {...}
func (x *Hello) GetMeaninglessCount() int32 {...}

...
```

ä¸Šé¢æŠ½å‡ºæ¥çš„è¿™äº›ä»£ç æˆ‘ä»¬éƒ½å¾ˆç†Ÿæ‚‰äº†ï¼Œå®ƒæŠŠ proto æ–‡ä»¶ä¸­å†™çš„ `message` ç¿»è¯‘æˆäº† golang çš„ç»“æ„ä½“ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½ç›´æ¥åœ¨ Go ä¸­ä½¿ç”¨è¿™ä¸ªç»“æ„äº†ã€‚

åœ¨ç¼–è¯‘æ—¶ï¼Œä½ ä¹Ÿå¯ä»¥ç¼–è¯‘æˆå…¶ä»–è¯­è¨€çš„ï¼Œç”¨ `--<lang>_out` æŒ‡å®šä¸€ä¸ªè¾“å‡ºç›®å½•å°±è¡Œäº†ï¼š

```sh
$ protoc --java_out=. --cpp_out=. hello.proto
```

ä½ å¯ä»¥ç”Ÿæˆå„ç§è¯­è¨€çš„ä»£ç çœ‹çœ‹ï¼ŒGo ç”Ÿæˆçš„ä»£ç ç»å¯¹æ˜¯æœ€ç®€æ´ã€æœ€çœ‹å¾—æ‡‚çš„ï¼ˆä¹‹ä¸€ï¼‰ã€‚

### Protobuf è¯­æ³•

æˆ‘ä»¬æŠŠ Protocol Buffers ä»£ç å†™åœ¨ `.proto` æ–‡ä»¶ä¸­ã€‚

Protobuf çš„æ³¨é‡Šè¿˜æ˜¯æˆ‘ä»¬ç†Ÿæ‚‰çš„ C/C++ é£æ ¼ï¼š

```protobuf
// è¿™æ˜¯æ³¨é‡Š
/* è¿™ä¹Ÿæ˜¯æ³¨é‡Š */
```

#### è¯­æ³•ç‰ˆæœ¬

`.proto` çš„ç¬¬ä¸€è¡Œä¼šæŒ‡æ˜æ‰€ç”¨çš„è¯­æ³•ç‰ˆæœ¬ï¼Œæˆ‘ä»¬ç°åœ¨ç”¨çš„æ˜¯ proto3 ç‰ˆæœ¬ï¼š

```protobuf
syntax = "proto3";
```

#### å¯¼å…¥

Protocol Buffers æ–‡ä»¶ä¹Ÿå¯ä»¥å¯¼å…¥å…¶ä»–æ–‡ä»¶ä¸­çš„å†…å®¹ï¼š

```protobuf
import "project/others.proto"
```

#### åŒ…å£°æ˜

Protocol Buffers ä½¿ç”¨ `package` å…³é”®å­—æ¥å£°æ˜åŒ…ï¼ˆå¯é€‰ï¼‰ï¼š

```protobuf
package foo.bar;
```

å¦‚æœéœ€è¦æŒ‡å®šåœ¨ä¸åŒè¯­è¨€ä¸­çš„åç§°ï¼Œå¯ä»¥ä½¿ç”¨ `option`ï¼š

```protobuf
option java_package = "com.example.foo";
```

#### æ¶ˆæ¯

ç”¨ `message` å…³é”®å­—æ¥å®šä¹‰æ¶ˆæ¯ã€‚æ¶ˆæ¯ï¼Œå°±æ˜¯ RPC ä¸­å®¢æˆ·ç«¯ç»™æœåŠ¡ç«¯ç©¿çš„å‚æ•°ä»¥åŠæœåŠ¡ç«¯ç»™å®¢æˆ·ç«¯è¿”å›çš„ç»“æœã€‚ä½¿ç”¨ `message MsgName {...}` çš„è¯­æ³•æ¥å£°æ˜ï¼š

```protobuf
message SongServerRequest {
	string song_name = 1;
}
```

Message çš„åç§°ä¸€èˆ¬ç”¨**é©¼å³°å‘½å**ã€‚message çš„å†…å®¹æ˜¯ä¸€äº›ä¸ªã€Œå­—æ®µã€ã€‚

#### å­—æ®µ

å­—æ®µçš„æ ¼å¼ä¸ºï¼š

```protobuf
{repeated} <type> <field_name> = <fieldNumber> { [ fieldOptions ] };
```

> è¿™é‡ŒèŠ±æ‹¬å·ä¸­çš„å†…å®¹æ˜¯å¯é€‰çš„ï¼Œå°–æ‹¬å·ä¸­çš„å†…å®¹æ˜¯éœ€è¦æ›¿æ¢çš„ï¼Œåé¢çš„ `[ fieldOptions ]` æ–¹æ‹¬å·æ˜¯protobuf è¯­æ³•çš„ä¸€éƒ¨åˆ†ã€‚

å»æ‰æ‰€æœ‰å¯é€‰éƒ¨åˆ†ï¼Œä¸€ä¸ªæœ€åŸºæœ¬çš„å­—æ®µå†™ä½œ `type field_name = fieldNumber`ï¼š

```protobuf
string song_name = 1;
```

- `type` å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯å­—æ®µçš„æ•°æ®ç±»å‹ï¼Œåé¢ä¼šè¯¦ç»†ä»‹ç»ã€‚
- `field_name` æ˜¯å­—æ®µåç§°ï¼Œé‡‡ç”¨**ä¸‹åˆ’çº¿å‘½å**ã€‚
- `fieldNumber` æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå­—æ®µçš„ç¼–å·ã€‚

ä¸€ä¸ª message çš„æ¯ä¸ªå­—æ®µéƒ½è¦è¿™ä¸ªå”¯ä¸€ç¼–å·ã€‚å»ºè®®ä¸€æ¬¡å†™å¥½åæ°¸è¿œä¹Ÿä¸è¦æ”¹è¿™ä¸ªç¼–å·ï¼Œå› ä¸ºè¿™ä¸ªç¼–å·æ˜¯ç”¨äºä»¥æ¶ˆæ¯äºŒè¿›åˆ¶æ ¼å¼æ ‡è¯†å­—æ®µçš„ã€‚éœ€è¦æ³¨æ„ä¸€ç‚¹æ˜¯ï¼Œæœ€å¥½æŠŠå‡ºç°é¢‘ç¹çš„æ¶ˆæ¯å…ƒç´ ä½¿ç”¨ç¼–å· 1~15ï¼ˆåªéœ€ä¸€å­—èŠ‚ç¼–ç ï¼‰ï¼Œæ›´å¤§çš„æ•°å­—å°±éœ€è¦æ›´å¤šç©ºé—´äº†ï¼Œå¯ç”¨çš„å–å€¼èŒƒå›´æ˜¯ `[1, 19000) U (20000, 2^29)`ï¼ˆä¸­é—´æŒ–æ‰çš„æ˜¯ protocol buffers ä¿ç•™çš„ ï¼‰

#### ç±»å‹

protobuf æ”¯æŒçš„åŸºæœ¬ç±»å‹æœ‰ï¼š

| ç±»å‹           | proto                  | å¯¹åº” go ç±»å‹         | è¯´æ˜                                   |
| -------------- | ---------------------- | -------------------- | -------------------------------------- |
| å­—èŠ‚æ•°ç»„       | `bytes`                | `[]byte`             | é•¿åº¦ä¸è¶…è¿‡ `2^32`                      |
| å­—ç¬¦ä¸²         | `string`               | `string`             |                                        |
| å¸ƒå°”ç±»å‹       | `bool`                 | `bool`               |                                        |
| æ•´æ•°           | `int32`ï¼Œ`int64`       | `int32`ï¼Œ`int64`     | å˜é•¿ç¼–ç ï¼Œå¯¹è´Ÿæ•°ç¼–ç æ•ˆç‡ä½             |
| æ— ç¬¦å·æ•´æ•°     | `uint32`ï¼Œ`uint64`     | `uint32`ï¼Œ`uint64`   | å˜é•¿ç¼–ç                                |
| æœ‰ç¬¦å·æ•´æ•°     | `sint32`ï¼Œ`sint64`     | `int32`ï¼Œ`int64`     | å˜é•¿ç¼–ç ï¼Œå¯¹è´Ÿæ•°ç¼–ç æ¯” `int32/64` é«˜æ•ˆ |
| å®šé•¿æ•´æ•°       | `fixed32`ï¼Œ`fixed64`   | `int32`ï¼Œ`int64`     | å›ºå®šç©ºé—´ï¼Œå®šé•¿ç¼–ç ï¼Œé€‚åˆå¤§æ•°           |
| å®šé•¿æœ‰ç¬¦å·æ•´æ•° | `sfixed32`ï¼Œ`sfixed64` | `int32`ï¼Œ`int64`     | å®šé•¿ç¼–ç                                |
| æµ®ç‚¹æ•°         | `float`ï¼Œ`double`      | `float32`ï¼Œ`float64` |                                        |

æ­¤å¤–ï¼Œè¿˜æœ‰å‡ ä¸ªå¤åˆç±»å‹ï¼š

**map**

`map` æ˜¯é”®å€¼å¯¹ç±»å‹ï¼š

```protobuf
map<string, int64> something = 1;
```

**enum**

```protobuf
enum EnumNotAllowingAlias {
  UNKNOWN2 = 0;
  STARTED2 = 1;
}
```

**reserved**

reserved ç”¨æ¥æŒ‡æ˜æ­¤ message ä¸ä½¿ç”¨ï¼ˆä¿ç•™ï¼‰æŸäº›å­—æ®µã€‚é€šè¿‡ç¼–ç æˆ–å­—æ®µåæ¥è®¾ç½®ä¿ç•™ï¼š

```protobuf
message AllNormalypes {
  reserved 2, 4 to 6;
  reserved "field14", "field11";
  double field1 = 1;
  // float field2 = 2;
  int32 field3 = 3;
  // int64 field4 = 4;
  // uint32 field5 = 5;
  // uint64 field6 = 6;
  sint32 field7 = 7;
  sint64 field8 = 8;
  fixed32 field9 = 9;
  fixed64 field10 = 10;
  // sfixed32 field11 = 11;
  sfixed64 field12 = 12;
  bool field13 = 13;
  // string field14 = 14;
  bytes field15 = 15;
}
```

å£°æ˜ä¿ç•™çš„å­—æ®µå°±ä¸èƒ½å†å®šä¹‰ï¼Œå¦åˆ™ç¼–è¯‘ä¼šå‡ºé”™ã€‚

**message**

ä¸€ä¸ª message å¯ä»¥ä½œä¸ºå¦ä¸€ä¸ª message çš„å­—æ®µå‡ºç°ï¼š

```protobuf
message SomeOtherMessage {
  SearchResponse.Result result = 1;
  message Result {
    string url = 1;
    string title = 2;
    repeated string snippets = 3;
  }
}
```

#### æœåŠ¡

æˆ‘ä»¬å¸¸æŠŠ Proto Buffers  ç”¨åœ¨ RPC é‡Œå˜›ï¼Œæ‰€ä»¥ Proto Buffers  æ˜¯å¯ä»¥ç›´æ¥å®šä¹‰ RPC æœåŠ¡æ¥å£çš„ã€‚è¿™ä¸ªæ¥å£å¯ä»¥ç›´æ¥ç”¨ gRPC å»å®ç°ï¼š

```protobuf
service SearchService {
  rpc Search (SearchRequest) returns (SearchResponse);
}
```

ç¼–è¯‘æ—¶ Proto Buffers ä¼šæ ¹æ®é€‰æ‹©çš„è¯­è¨€ç”ŸæˆæœåŠ¡æ¥å£ä»£ç å’Œå­˜æ ¹ï¼ˆStubï¼‰ã€‚

æ¥ä¸‹æ¥ï¼Œä»‹ç»å¦‚ä½•åœ¨ gRPC ä¸­ä½¿ç”¨ Ptotobufã€‚

## gRPC

