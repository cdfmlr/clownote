---
date: 2020-09-15 14:54:19.363229
tags: Golang
title: Go å¾®æœåŠ¡åŸºç¡€ï¼šProtobuf & gRPC
---
# Go å¾®æœåŠ¡åŸºç¡€ï¼šProtobuf & gRPC

è¿™ç¯‡æ–‡ç« å†™çš„ç¨å¾®æœ‰ç‚¹ä¹±ï¼Œå› ä¸ºå†™ä½œè¿‡ç¨‹ä¸­æ€è·¯æœ‰å¤§æ–­æµã€‚

æœ¬æ–‡å†æ—¶å¾ˆå¤šå¤©ï¼ŒæœŸé—´æˆ‘çš„ä¸¤å¤§ä¸»è¦å¼€å‘ç¯å¢ƒ â€”â€” Python å’Œ Golang éƒ½ç‚¸äº†ï¼Œé¡ºä¾¿ï¼ŒåŒ…ç®¡ç†å·¥å…· Homebrew ä¹Ÿå‡ºäº†ç‚¹å°é—®é¢˜ï¼ˆå…¨éƒ½æ˜¯å› ä¸ºä¸€æ¡æ²¡ç»è¿‡æ·±æ€çš„é”™è¯¯çš„ `brew upgrade` å‘½ä»¤ï¼‰ã€‚å°è¯•æ‰‹åŠ¨ä¿®å¤ï¼Œæäº†ä¸€å¤©ï¼Œæ— æœã€‚æ²¡åŠæ³• Time Machine æ¢å¤äº†ä¸€ä¸‹ï¼Œç”±äºæœ€è¿‘å‡ å¤©éƒ½æ²¡å¤‡ä»½ğŸ˜­ï¼ŒS/L å¤§æ³•ä¸å¤ªçµï¼Œå®ƒä¸€ä¸‹å­ç»™æˆ‘å›åˆ°äº†åå¤©å‰ã€‚å„ç§æ‰‹åŠ¨æ£€æŸ¥ã€æ¸…ç†ã€git pullï¼ŒåˆèŠ±è´¹äº†ä¸€å¤©ã€‚ã€‚ã€‚

ä¸è¿‡è¿™äº›æ€ä¹ˆæ ·éƒ½æ— æ‰€è°“å•¦ï¼Œæˆ‘æƒ³è¯´çš„æ˜¯ï¼Œå¤§å®¶åœ¨æ•²å›è½¦å‰è¿˜æ˜¯è¦ä¸‰æ€ï¼Œå°¤å…¶æ˜¯ä½¿ç”¨ç®¡ç†å‘˜æƒé™æ—¶ã€‚è¿˜æœ‰å¤‡ä»½ä¸è¦å¿˜å•Šï¼Œå†å¿™ä¹Ÿè¦è®°å¾—åšå¤‡ä»½å“¦ã€‚

---

~~æˆ‘ä»¬å¼€é—¨è§å±±~~ï¼ŒåºŸè¯ç»“æŸï¼è¿™ç¯‡æ–‡ç« å‰åŠéƒ¨åˆ†ä»‹ç»äº† Protocol Buffers çš„å®‰è£…ä½¿ç”¨å’ŒåŸºæœ¬è¯­æ³•ã€‚ååŠéƒ¨åˆ†åŸºäº Golangï¼Œé€šè¿‡ä¸€ä¸ªå®ä¾‹ï¼Œä»‹ç» Protobuf ä¸ gRPC çš„ä½¿ç”¨ã€‚

[TOC]

## Protobuf

> [Protocol Buffers](https://developers.google.com/protocol-buffers) æ˜¯ä¸€ç§åºåˆ—åŒ–æ•°æ®ç»“æ„çš„åè®®ã€‚å¯¹äºé€è¿‡ç®¡é“æˆ–å­˜å‚¨æ•°æ®è¿›è¡Œé€šä¿¡çš„ç¨‹åºå¼€å‘ä¸Šæ˜¯å¾ˆæœ‰ç”¨çš„ã€‚è¿™ä¸ªæ–¹æ³•åŒ…å«ä¸€ä¸ªæ¥å£æè¿°è¯­è¨€ï¼Œæè¿°ä¸€äº›æ•°æ®ç»“æ„ï¼Œå¹¶æä¾›ç¨‹åºå·¥å…·æ ¹æ®è¿™äº›æè¿°äº§ç”Ÿä»£ç ï¼Œç”¨äºå°†è¿™äº›æ•°æ®ç»“æ„äº§ç”Ÿæˆ–è§£ææ•°æ®æµã€‚
>
> â€”â€”  [WikiPedia](https://zh.wikipedia.org/zh-cn/Protocol_Buffers)

æ€»è€Œè¨€ä¹‹ï¼Œ [Protocol Buffers](https://developers.google.com/protocol-buffers)ï¼Œç®€ç§° Protobufï¼Œ æ˜¯ä¸€ç§æ•°æ®æè¿°è¯­è¨€ï¼ˆå’Œ XMLã€JSON è¿™äº›ç±»ä¼¼ï¼‰ã€‚Protobuf é…å¥—çš„å·¥å…·å¯ä»¥è‡ªåŠ¨ç”Ÿæˆå°†å„ç§è¯­è¨€ä¸­çš„æ•°æ®ç»“æ„åºåˆ—åŒ–ä¸º Protobuf è¡¨ç¤ºï¼Œç„¶åååºåˆ—åŒ–åˆ°ä»»æ„æ”¯æŒçš„è¯­è¨€ä¸­ã€‚

åœ¨ RPC ä¸­ï¼Œè·¨è¯­è¨€çš„æ•°æ®ç¼–ç ã€è§£ç æ˜¯ä¸ªé—®é¢˜ï¼Œ Protobuf æ˜¯ä¸€ç§æ¯”è¾ƒé«˜æ•ˆçš„è§£å†³æ–¹æ¡ˆã€‚gRPC å°±æ˜¯åŸºäº Protobuf çš„ä¸€å¥— RPC æ¡†æ¶ã€‚

### å®‰è£… Protobuf

åœ¨ macOS ä¸Šï¼Œä½¿ç”¨  homebrew å¯ä»¥å¿«é€Ÿå®‰è£… protobufã€‚ `brew` ç»å¯¹æ˜¯æˆ‘è§è¿‡æœ€çœäº‹çš„åŒ…ç®¡ç†ï¼Œå¿½ç•¥å›½å†…ä¼—æ‰€å‘¨çŸ¥çš„åŸå› å¸¦æ¥çš„ä¸€äº›å°é—®é¢˜ï¼Œå‡ ä¹æ»¡è¶³äº†ä¸€åˆ‡æ—¥å¸¸å®‰è£…éœ€è¦ï¼š

```sh
$ brew install protobuf
...
$ protoc --version
libprotoc 3.13.0
```

æˆ‘ä»¬è¦åœ¨ Golang ä¸­ä½¿ç”¨ protobufï¼Œéœ€è¦æŠŠ ptotobuf â€œç¼–è¯‘â€æˆ Golangï¼Œéœ€è¦å®‰è£…  protoc-gen-go å·¥å…·æ¥åšè¿™ä»¶äº‹ï¼š

```sh
$ go install google.golang.org/protobuf/cmd/protoc-gen-go
```

ä¸‹é¢å…ˆå°è¯•ä½¿ç”¨å®ƒå®Œæˆä¸€æ¬¡ HelloWorldï¼Œåé¢å†ä»‹ç» Protobuf çš„åŸºæœ¬è¯­æ³•å‘€ã€‚

### ä½¿ç”¨ Protobuf

é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ª `hello.proto` æ–‡ä»¶ï¼š

```sh
$ vim hello.proto
```

å†™å…¥å¦‚ä¸‹ Protocol Buffers ä»£ç ï¼š

```protobuf
syntax =  "proto3";

package hello;

message Hello {
  string world = 1;
  int32 meaningless_count = 2;
}
```

ç¼–è¯‘ï¼Œç”Ÿæˆ Golang ä»£ç ï¼š

```sh
$ protoc --go_out=. hello.proto
```

`go_out` å‘Šè¯‰ protoc ç¼–è¯‘å™¨åŠ è½½ protoc-gen-go å·¥å…·æ¥ç”Ÿæˆä»£ç ï¼ŒæŠŠç”Ÿæˆä»£ç æ”¾åˆ°å½“å‰ç›®å½•ã€‚å¿½ç•¥æ‰“å°çš„ WARNINGï¼Œ`protoc` åœ¨å½“å‰è·¯å¾„ä¸‹ç”Ÿæˆäº†ä¸€ä¸ª `hello.pb.go` çš„æ–‡ä»¶ã€‚é‡Œé¢æœ‰å¾ˆå¤šå†…å®¹ï¼ŒåŒ…æ‹¬ï¼š

```go
// Code generated by protoc-gen-go. DO NOT EDIT.
// versions:
// 	protoc-gen-go v1.25.0
// 	protoc        v3.13.0
// source: hello.proto

package hello

type Hello struct {
    ...
    World            string `protobuf:"bytes,1,opt,name=world,proto3" json:"world,omitempty"`
    MeaninglessCount int32  `protobuf:"varint,2,opt,name=meaningless_count,json=meaninglessCount,proto3" json:"meaningless_count,omitempty"`
}

func (x *Hello) Reset() {...}
func (x *Hello) String() string {...}
func (*Hello) ProtoMessage() {}
func (x *Hello) ProtoReflect() protoreflect.Message {...}
func (*Hello) Descriptor() ([]byte, []int) {...}
func (x *Hello) GetWorld() string {...}
func (x *Hello) GetMeaninglessCount() int32 {...}

...
```

ä¸Šé¢æŠ½å‡ºæ¥çš„è¿™äº›ä»£ç æˆ‘ä»¬éƒ½å¾ˆç†Ÿæ‚‰äº†ï¼Œå®ƒæŠŠ proto æ–‡ä»¶ä¸­å†™çš„ `message` ç¿»è¯‘æˆäº† golang çš„ç»“æ„ä½“ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½ç›´æ¥åœ¨ Go ä¸­ä½¿ç”¨è¿™ä¸ªç»“æ„äº†ã€‚

åœ¨ç¼–è¯‘æ—¶ï¼Œä½ ä¹Ÿå¯ä»¥ç¼–è¯‘æˆå…¶ä»–è¯­è¨€çš„ï¼Œç”¨ `--<lang>_out` æŒ‡å®šä¸€ä¸ªè¾“å‡ºç›®å½•å°±è¡Œäº†ï¼š

```sh
$ protoc --java_out=. --cpp_out=. hello.proto
```

ä½ å¯ä»¥ç”Ÿæˆå„ç§è¯­è¨€çš„ä»£ç çœ‹çœ‹ï¼ŒGo ç”Ÿæˆçš„ä»£ç ç»å¯¹æ˜¯æœ€ç®€æ´ã€æœ€çœ‹å¾—æ‡‚çš„ï¼ˆä¹‹ä¸€ï¼‰ã€‚

### Protobuf è¯­æ³•

æˆ‘ä»¬æŠŠ Protocol Buffers ä»£ç å†™åœ¨ `.proto` æ–‡ä»¶ä¸­ã€‚

#### æ³¨é‡Š

Protobuf çš„æ³¨é‡Šè¿˜æ˜¯æˆ‘ä»¬ç†Ÿæ‚‰çš„ C/C++ é£æ ¼ï¼š

```protobuf
// è¿™æ˜¯æ³¨é‡Š
/* è¿™ä¹Ÿæ˜¯æ³¨é‡Š */
```

#### è¯­æ³•ç‰ˆæœ¬

`.proto` çš„ç¬¬ä¸€è¡Œä¼šæŒ‡æ˜æ‰€ç”¨çš„è¯­æ³•ç‰ˆæœ¬ï¼Œæˆ‘ä»¬ç°åœ¨ç”¨çš„æ˜¯ proto3 ç‰ˆæœ¬ï¼š

```protobuf
syntax = "proto3";
```

#### å¯¼å…¥

Protocol Buffers æ–‡ä»¶ä¹Ÿå¯ä»¥å¯¼å…¥å…¶ä»–æ–‡ä»¶ä¸­çš„å†…å®¹ï¼š

```protobuf
import "project/others.proto"
```

#### åŒ…å£°æ˜

Protocol Buffers ä½¿ç”¨ `package` å…³é”®å­—æ¥å£°æ˜åŒ…ï¼ˆå¯é€‰ï¼‰ï¼š

```protobuf
package foo.bar;
```

å¦‚æœéœ€è¦æŒ‡å®šåœ¨ä¸åŒè¯­è¨€ä¸­çš„åç§°ï¼Œå¯ä»¥ä½¿ç”¨ `option`ï¼š

```protobuf
option java_package = "com.example.foo";
```

#### æ¶ˆæ¯

ç”¨ `message` å…³é”®å­—æ¥å®šä¹‰æ¶ˆæ¯ã€‚æ¶ˆæ¯ï¼Œå°±æ˜¯ RPC ä¸­å®¢æˆ·ç«¯ç»™æœåŠ¡ç«¯ç©¿çš„å‚æ•°ä»¥åŠæœåŠ¡ç«¯ç»™å®¢æˆ·ç«¯è¿”å›çš„ç»“æœã€‚ä½¿ç”¨ `message MsgName {...}` çš„è¯­æ³•æ¥å£°æ˜ï¼š

```protobuf
message SongServerRequest {
  string song_name = 1;
}
```

Message çš„åç§°ä¸€èˆ¬ç”¨**é©¼å³°å‘½å**ã€‚message çš„å†…å®¹æ˜¯ä¸€äº›ä¸ªã€Œå­—æ®µã€ã€‚

#### å­—æ®µ

å­—æ®µçš„æ ¼å¼ä¸ºï¼š

```protobuf
{repeated} <type> <field_name> = <fieldNumber> { [ fieldOptions ] };
```

> è¿™é‡ŒèŠ±æ‹¬å·ä¸­çš„å†…å®¹æ˜¯å¯é€‰çš„ï¼Œå°–æ‹¬å·ä¸­çš„å†…å®¹æ˜¯éœ€è¦æ›¿æ¢çš„ï¼Œåé¢çš„ `[ fieldOptions ]` æ–¹æ‹¬å·æ˜¯protobuf è¯­æ³•çš„ä¸€éƒ¨åˆ†ã€‚

å»æ‰æ‰€æœ‰å¯é€‰éƒ¨åˆ†ï¼Œä¸€ä¸ªæœ€åŸºæœ¬çš„å­—æ®µå†™ä½œ `type field_name = fieldNumber`ï¼š

```protobuf
string song_name = 1;
```

- `type` å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯å­—æ®µçš„æ•°æ®ç±»å‹ï¼Œåé¢ä¼šè¯¦ç»†ä»‹ç»ã€‚
- `field_name` æ˜¯å­—æ®µåç§°ï¼Œé‡‡ç”¨**ä¸‹åˆ’çº¿å‘½å**ã€‚
- `fieldNumber` æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå­—æ®µçš„ç¼–å·ã€‚

ä¸€ä¸ª message çš„æ¯ä¸ªå­—æ®µéƒ½è¦è¿™ä¸ªå”¯ä¸€ç¼–å·ã€‚å»ºè®®ä¸€æ¬¡å†™å¥½åæ°¸è¿œä¹Ÿä¸è¦æ”¹è¿™ä¸ªç¼–å·ï¼Œå› ä¸ºè¿™ä¸ªç¼–å·æ˜¯ç”¨äºä»¥æ¶ˆæ¯äºŒè¿›åˆ¶æ ¼å¼æ ‡è¯†å­—æ®µçš„ã€‚éœ€è¦æ³¨æ„ä¸€ç‚¹æ˜¯ï¼Œæœ€å¥½æŠŠå‡ºç°é¢‘ç¹çš„æ¶ˆæ¯å…ƒç´ ä½¿ç”¨ç¼–å· 1~15ï¼ˆåªéœ€ä¸€å­—èŠ‚ç¼–ç ï¼‰ï¼Œæ›´å¤§çš„æ•°å­—å°±éœ€è¦æ›´å¤šç©ºé—´äº†ï¼Œå¯ç”¨çš„å–å€¼èŒƒå›´æ˜¯ `[1, 19000) U (20000, 2^29)`ï¼ˆä¸­é—´æŒ–æ‰çš„æ˜¯ protocol buffers ä¿ç•™çš„ ï¼‰

#### ç±»å‹

protobuf æ”¯æŒçš„åŸºæœ¬ç±»å‹æœ‰ï¼š

| ç±»å‹           | proto                  | å¯¹åº” go ç±»å‹         | è¯´æ˜                                   |
| -------------- | ---------------------- | -------------------- | -------------------------------------- |
| å­—èŠ‚æ•°ç»„       | `bytes`                | `[]byte`             | é•¿åº¦ä¸è¶…è¿‡ `2^32`                      |
| å­—ç¬¦ä¸²         | `string`               | `string`             |                                        |
| å¸ƒå°”ç±»å‹       | `bool`                 | `bool`               |                                        |
| æ•´æ•°           | `int32`ï¼Œ`int64`       | `int32`ï¼Œ`int64`     | å˜é•¿ç¼–ç ï¼Œå¯¹è´Ÿæ•°ç¼–ç æ•ˆç‡ä½             |
| æ— ç¬¦å·æ•´æ•°     | `uint32`ï¼Œ`uint64`     | `uint32`ï¼Œ`uint64`   | å˜é•¿ç¼–ç                                |
| æœ‰ç¬¦å·æ•´æ•°     | `sint32`ï¼Œ`sint64`     | `int32`ï¼Œ`int64`     | å˜é•¿ç¼–ç ï¼Œå¯¹è´Ÿæ•°ç¼–ç æ¯” `int32/64` é«˜æ•ˆ |
| å®šé•¿æ•´æ•°       | `fixed32`ï¼Œ`fixed64`   | `int32`ï¼Œ`int64`     | å›ºå®šç©ºé—´ï¼Œå®šé•¿ç¼–ç ï¼Œé€‚åˆå¤§æ•°           |
| å®šé•¿æœ‰ç¬¦å·æ•´æ•° | `sfixed32`ï¼Œ`sfixed64` | `int32`ï¼Œ`int64`     | å®šé•¿ç¼–ç                                |
| æµ®ç‚¹æ•°         | `float`ï¼Œ`double`      | `float32`ï¼Œ`float64` |                                        |

æ­¤å¤–ï¼Œè¿˜æœ‰å‡ ä¸ªå¤åˆç±»å‹ï¼š

**repeated**

`repeated` å¯ä»¥ç”¨æ¥è¡¨ç¤ºå¯å˜æ•°ç»„ï¼Œä¹Ÿå°±ç›¸å½“äº Golang çš„åˆ‡ç‰‡ç±»å‹ã€‚

```protobuf
repeated string hobby = 1;
```

è¿™é‡Œçš„ hobby å°±å¯ä»¥æœ‰å¥½å¤šä¸ªå€¼ï¼Œç¼–è¯‘æˆ Golang å¯ä»¥çœ‹åˆ°å®ƒå°±æ˜¯ä¸€ä¸ª `[]string`ï¼š

```go
Hobby []string `protobuf:"bytes,1,rep,name=hobby,proto3" json:"hobby,omitempty"`
```

**map**

`map` æ˜¯é”®å€¼å¯¹ç±»å‹ï¼š

```protobuf
map<string, int64> something = 1;
```

**enum**

```protobuf
enum EnumNotAllowingAlias {
  UNKNOWN2 = 0;
  STARTED2 = 1;
}
```

**reserved**

reserved ç”¨æ¥æŒ‡æ˜æ­¤ message ä¸ä½¿ç”¨ï¼ˆä¿ç•™ï¼‰æŸäº›å­—æ®µã€‚é€šè¿‡ç¼–ç æˆ–å­—æ®µåæ¥è®¾ç½®ä¿ç•™ï¼š

```protobuf
message AllNormalypes {
  reserved 2, 4 to 6;
  reserved "field14", "field11";
  double field1 = 1;
  // float field2 = 2;
  int32 field3 = 3;
  // int64 field4 = 4;
  // uint32 field5 = 5;
  // uint64 field6 = 6;
  sint32 field7 = 7;
  sint64 field8 = 8;
  fixed32 field9 = 9;
  fixed64 field10 = 10;
  // sfixed32 field11 = 11;
  sfixed64 field12 = 12;
  bool field13 = 13;
  // string field14 = 14;
  bytes field15 = 15;
}
```

å£°æ˜ä¿ç•™çš„å­—æ®µå°±ä¸èƒ½å†å®šä¹‰ï¼Œå¦åˆ™ç¼–è¯‘ä¼šå‡ºé”™ã€‚

**message**

ä¸€ä¸ª message å¯ä»¥ä½œä¸ºå¦ä¸€ä¸ª message çš„å­—æ®µå‡ºç°ï¼š

```protobuf
message SomeOtherMessage {
  SearchResponse.Result result = 1;
  message Result {
    string url = 1;
    string title = 2;
    repeated string snippets = 3;
  }
}
```

#### æœåŠ¡

æˆ‘ä»¬å¸¸æŠŠ Proto Buffers  ç”¨åœ¨ RPC é‡Œå˜›ï¼Œæ‰€ä»¥ Proto Buffers  æ˜¯å¯ä»¥ç›´æ¥å®šä¹‰ RPC æœåŠ¡æ¥å£çš„ã€‚è¿™ä¸ªæ¥å£å¯ä»¥ç›´æ¥ç”¨ gRPC å»å®ç°ï¼š

```protobuf
service SearchService {
  rpc Search (SearchRequest) returns (SearchResponse);
}
```

ç¼–è¯‘æ—¶ Proto Buffers ä¼šæ ¹æ®é€‰æ‹©çš„è¯­è¨€ç”ŸæˆæœåŠ¡æ¥å£ä»£ç å’Œå­˜æ ¹ï¼ˆStubï¼‰ã€‚

æ¥ä¸‹æ¥ï¼Œä»‹ç»å¦‚ä½•åœ¨ gRPC ä¸­ä½¿ç”¨ Ptotobufã€‚

## gRPC with Golang

ä»€ä¹ˆæ˜¯ gRPCï¼Ÿå®˜ç½‘ä¸Šå®ƒç»™è‡ªå·±ä¸‹çš„å®šä¹‰æ˜¯ A high-performance, open source universal RPC framework â€”â€” ä¸€ä¸ªé«˜æ€§èƒ½çš„å¼€æºé€šç”¨ RPC æ¡†æ¶ã€‚

gRPC åœ¨é€šä¿¡çš„è¿‡ç¨‹ä¸­ä½¿ç”¨ Protobufã€‚æ‰€ä»¥å®ƒåŸºæœ¬ä¸Š Protobuf æ”¯æŒçš„è¯­è¨€ gRPC éƒ½æ”¯æŒï¼ŒGoã€C++ã€Javaã€Python è¿™äº›æˆ‘ä»¬å¸¸ç”¨çš„åç«¯è¯­è¨€éƒ½å¯ä»¥ç”¨ gRPCï¼Œè€Œä¸”æ˜¯å¯ä»¥è·¨è¯­è¨€è°ƒç”¨ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç€çœ¼äº Golangï¼Œé€šè¿‡ä¸€ä¸ªç®€å•å®ä¾‹ï¼Œçœ‹çœ‹ gRPC å¦‚ä½•ä½¿ç”¨ã€‚

æˆ‘ä»¬çš„ç›®æ ‡æ˜¯åšä¸€ä¸ªå¤„ç†ç”¨æˆ·ä¿¡æ¯çš„ RPC å®ä¾‹ã€‚å®¢æˆ·ç«¯é€šè¿‡ç»™å®šç”¨æˆ·åï¼Œä»æœåŠ¡ç«¯æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ã€‚

æœ€ç»ˆå®ç°çš„é¡¹ç›®ç»“æ„å¦‚ä¸‹ï¼š

```sh
grpc
â”œâ”€â”€ client
â”‚Â Â  â””â”€â”€ main.go
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ proto
â”‚Â Â  â”œâ”€â”€ user.pb.go
â”‚Â Â  â”œâ”€â”€ user.proto
â”‚Â Â  â””â”€â”€ user_grpc.pb.go
â””â”€â”€ server
    â””â”€â”€ main.go
```

- proto ç›®å½•é‡Œæˆ‘ä»¬å†™ `user.proto` æ¥å®šä¹‰ RPC æœåŠ¡æ¥å£ã€‚
- server å®ç°ä¸€ä¸ª gRPC æœåŠ¡ç«¯ã€‚
- client å®ç°å®¢æˆ·ç«¯ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½• grpc ç›®å½•ä¸‹åˆå§‹åŒ–äº†ä¸€ä¸ª go æ¨¡å—ï¼š

```sh
$ go mod init grpc.learn
```

å®‰è£… gRPC çš„ Go åŒ…ï¼š

```go
$ go get goole.golang.org/grpc
```


### Protobuf ç¼–å†™

```protobuf
syntax = "proto3";

package proto;

// ç”¨æˆ·ä¿¡æ¯è¯·æ±‚å‚æ•°
message UserRequest {
  string name = 1;
}

// ç”¨æˆ·ä¿¡æ¯è¯·æ±‚å“åº”
message UserResponse {
  int32 id = 1;
  string name = 2;
  int32 age = 3;
  repeated string hobby = 4;
}

// ç”¨æˆ·ä¿¡æ¯æ¥å£
service UserInfo {
  // è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œè¯·æ±‚å‚æ•°ä¸º UserRequestï¼Œè¿”å›å“åº”ä¸º UserResponse
  rpc GetUserInfo (UserRequest) returns (UserResponse) {}
}
```

### Protobuf ç¼–è¯‘

è¿™é‡Œæˆ‘é‡åˆ°ä¸€ä¸ªå‘ï¼Œ ç½‘ä¸Šçš„èµ„æ–™ä¸€èˆ¬éƒ½æ˜¯æ•™ç”¨ï¼š

```sh
protoc --go_out=plugins=grpc:. user.proto
```

ä½†ç°åœ¨ï¼ˆ2020.08.18ï¼‰è¿™ä¸ªä¸è¡Œäº†ï¼Œä¼šæŠ¥é”™ï¼š

```sh
--go_out: protoc-gen-go: plugins are not supported; use 'protoc --go-grpc_out=...' to generate gRPC
```

æˆ‘æŸ¥äº† [gRPC å®˜ç½‘çš„æœ‰å…³æ–‡æ¡£](https://grpc.io/docs/languages/go/quickstart/#regenerate-grpc-code)ï¼Œä»¥åŠæœ‰å…³çš„ GitHub [gRPC Issue 298](https://github.com/grpc/grpc.io/issues/298)ã€[Protobuf Issue 1070](https://github.com/golang/protobuf/issues/1070) ç­‰ç­‰ä¸€äº›ä¸œè¥¿ã€‚æ€»è€Œè¨€ä¹‹ï¼ŒProtobuf ç”Ÿæˆ gRPC ä»£ç çš„å·¥å…·æœ€è¿‘æœ‰äº›å˜åŒ–ï¼Œç›®å‰ä½¿ç”¨ protoc ç”Ÿæˆ Golang çš„ gRPC ä»£ç ï¼Œéœ€è¦å®‰è£…ä¸€ä¸ªé¢å¤–çš„åŒ…ï¼š

```sh
$ go install google.golang.org/grpc/cmd/protoc-gen-go-grpc
```

ç„¶åï¼š

```sh
$ cd proto
$ protoc -I . --go_out=. --go-grpc_out=. ./user.proto
```

å¿½ç•¥è¾“å‡ºçš„ ` Missing 'go_package' option` WARNINGã€‚å°±å¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„æ¥å£æ–‡ä»¶äº†ï¼š

```go
proto/
â”œâ”€â”€ user.pb.go
â”œâ”€â”€ user.proto
â””â”€â”€ user_grpc.pb.go
```

- `--go_out` ç”Ÿæˆçš„  `user.pb.go` ä¸­å®šä¹‰äº† message åœ¨ golang ä¸­çš„ç»“æ„ä½“ï¼Œä»¥åŠå…¶ç¼–ç è§£ç ã€‚
- `--go-rpc_out` ç”Ÿæˆçš„ `user_grpc.pb.go` é‡Œé¢æ˜¯ service åœ¨ golang ä¸­çš„ gRPC æœåŠ¡ã€å®¢æˆ·ç«¯æ¥å£ã€‚

### æœåŠ¡ç«¯å®ç°

æŸ¥çœ‹ `user_grpc.pb.go` ä¸­çš„ä»£ç ï¼Œå‘ç°é‡Œé¢å®šä¹‰æœ‰è¿™äº›ä¸œè¥¿ï¼š

```go
// UserInfoService is the service API for UserInfo service.
// Fields should be assigned to their respective handler implementations only before
// RegisterUserInfoService is called.  Any unassigned fields will result in the
// handler for that method returning an Unimplemented error.
type UserInfoService struct {
	// è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œè¯·æ±‚å‚æ•°ä¸º UserRequestï¼Œè¿”å›å“åº”ä¸º UserResponse
	GetUserInfo func(context.Context, *UserRequest) (*UserResponse, error)
}

// RegisterUserInfoService registers a service implementation with a gRPC server.
func RegisterUserInfoService(s grpc.ServiceRegistrar, srv *UserInfoService) {...}
```

é æˆ‘å…­çº§é«˜è¾¾ 410 åˆ†çš„æƒŠäººè‹±è¯­å®åŠ›ï¼Œä¿¡è¾¾é›…åœ°ç¿»è¯‘ä¸€ä¸‹ï¼š

- `UserInfoService` æ˜¯ UserInfo æœåŠ¡çš„æœåŠ¡ç«¯æ¥å£ã€‚åœ¨è°ƒç”¨ `RegisterUserInfoService` ä¹‹å‰ï¼Œ åº”è¯¥å°†å„ç§æœåŠ¡åŠŸèƒ½çš„å…·ä½“å®ç°èµ‹ç»™ `UserInfoService` çš„å¯¹åº”å­—æ®µã€‚
- `RegisterUserInfoService` åœ¨ gRPC æœåŠ¡å™¨å®ä¾‹ä¸Šæ³¨å†Œä¸€ä¸ª `UserInfoService` å®ä¾‹ã€‚

æ–°å»ºä¸€ä¸ª `server/main.go`ï¼Œåœ¨é‡Œé¢ç¼–å†™å…·ä½“çš„æœåŠ¡ç«¯ä»£ç ã€‚é¦–å…ˆè¦å¯¼å…¥ protobuf çš„æ¥å£ï¼š

```go
import "grpc.learn/proto"
```

è¿™é‡Œæˆ‘æŠŠæ‰€æœ‰ä»£ç éƒ½æ”¾åˆ°ä¸€ä¸ªå« `grpc.learn` çš„ `go module` é‡Œäº†ï¼Œæ‰€ä»¥è¿™æ ·å»å– proto å­åŒ…ï¼ˆå³åˆšæ‰å†™çš„ proto æ–‡ä»¶ç”Ÿæˆä»£ç çš„åŒ…ï¼‰ã€‚

ä½ å»çœ‹ gRPC çš„å®˜æ–¹ä¾‹å­ï¼Œé‡Œé¢è¿˜ä¼šæœ‰ç»™è¿™ä¸ª protobuf æ¥å£çš„åŒ…å–ä¸ªåå­—ï¼š

```go
import (
	pb "google.golang.org/grpc/examples/helloworld/helloworld"
)
```

è¿™é‡Œæˆ‘æ²¡å–åå­—ï¼Œæ²¡å…³ç³»ï¼Œè¿™ä¸é‡è¦ã€‚

åœ¨ `UserInfoService` ä¸­ `GetUserInfo` å­—æ®µæ˜¯å‡½æ•°ç±»å‹çš„ã€‚æ‰€ä»¥å¯ä»¥æŠŠä¸€ä¸ªç¬¦åˆå£°æ˜çš„å‡½æ•°èµ‹ç»™ `UserInfoService` å®ä¾‹ï¼š

```go
// getUserInfo å®ç°å…·ä½“çš„è·å–ç”¨æˆ·ä¿¡æ¯çš„é€»è¾‘
func getUserInfo(ctx context.Context, request *proto.UserRequest) (response *proto.UserResponse, err error) {
	name := request.Name

	fmt.Println("GetUserInfo: name =", name)

	// Fake query
	if name == "foo" {
		response = &proto.UserResponse{
			Id:    1,
			Name:  "foo",
			Age:   12,
			Hobby: []string{"eating", "sleep"},
		}
		return response, nil
	}

	return response, fmt.Errorf("unknown user: name=%s", name)
}

// å®ä¾‹åŒ–ä¸€ä¸ª UserInfoService
var userInfoService = proto.UserInfoService{
	GetUserInfo: getUserInfo,
}
```

---

<details>
<summary>Tipsï¼šGolang å‡½æ•°ä¸å‡½æ•°ç±»å‹ ï¼ˆç»™ Go è¯­è¨€åˆå­¦è€…ï¼‰</summary>

Golang ä¸­å‡½æ•°æ˜¯ä¸€ç­‰å…¬æ°‘ï¼Œä»»ä½•å¯ä»¥ä½¿ç”¨å…¶ä»–ç±»å‹å¯¹è±¡çš„åœ°æ–¹éƒ½å¯ä»¥ä½¿ç”¨å‡½æ•°ã€‚

Golang ä¹Ÿæ”¯æŒå‡½æ•°ç±»å‹ï¼Œå³å°†ç›¸åŒå£°æ˜(å‚æ•°æ¥æ”¶ç›¸åŒä¸ªæ•°ã€ç±»å‹ï¼Œè¿”å›ç›¸åŒä¸ªæ•°ã€ç±»å‹)çš„å‡½æ•°çœ‹ä½œä¸€ä¸ªç±»å‹çš„ï¼Œå¯ä»¥ç”¨ type ç»™å‡½æ•°ç±»å‹å–åå­—ã€‚ä¾‹å¦‚ï¼š

```go
// Operation æ˜¯è®¡ç®—çš„æŠ½è±¡
type Operation func(Number1, Number2 float64) float64
```

æˆ‘ä»¬æŠŠå„ç§æ¥æ”¶ä¸¤ä¸ª float64 å‚æ•°ã€è¿”å› float64 çš„å‡½æ•°éƒ½çœ‹ä½œæ˜¯ Operation çš„**å®ä¾‹**ã€‚

```go
func Add(Number1, Number2 float64) float64 {
	return Number1 + Number2
}

func Sub(Number1, Number2 float64) float64 {
	return Number1 - Number2
}
```

Add å’Œ Sub éƒ½æ»¡è¶³äº†å£°æ˜ `func(Number1, Number2 float64) float64`ï¼Œæ‰€ä»¥éƒ½æ˜¯ Operation å‡½æ•°ç±»å‹çš„å®ä¾‹ã€‚å‡½æ•°ç±»å‹çš„å®ä¾‹æ˜¯å…·ä½“å¯è°ƒç”¨çš„å‡½æ•°ï¼š

```go
var oper Operation
oper = Add
oper(1.0, 1.0) // ç›¸å½“äºè°ƒç”¨ Add(1.0, 1.0)
```

å›åˆ° gRPCï¼Œæˆ‘ä»¬çš„ GetUserInfo æ˜¯ä¸€ä¸ª `func(context.Context, *UserRequest) (*UserResponse, error)` å‡½æ•°ç±»å‹çš„å­—æ®µï¼ˆåªæ˜¯æ²¡æœ‰ç»™è¿™ä¸ªå‡½æ•°ç±»å‹å–åå­—ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä»»ä½•æ»¡è¶³äº†è¿™ä¸ªå£°æ˜çš„å‡½æ•°èµ‹å€¼ç»™å®ƒã€‚è¿™é‡Œæˆ‘ä»¬æŠŠå…·ä½“å®ç° `getUserInfo` èµ‹ç»™ `GetUserInfo`ã€‚åœ¨å…¶ä»–åœ°æ–¹ä½¿ç”¨ `GetUserInfo(...)` æ—¶ï¼Œå°±ç›¸å½“äºä½¿ç”¨äº† `getUserInfo(...)`ã€‚

</details>

---

åœ¨ main å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å®ä¾‹åŒ–å¹¶å¼€å¯æœåŠ¡ã€‚é¦–å…ˆéœ€è¦å®ä¾‹åŒ–ä¸€ä¸ª grpc æœåŠ¡ï¼Œç„¶åæŠŠæˆ‘ä»¬çš„ UserInfo æœåŠ¡å®ä¾‹æ³¨å†Œä¸Šã€‚æ¥ä¸‹æ¥ï¼Œç›‘å¬ TCP ç½‘ç»œï¼Œåœ¨ç›‘å¬ä¸Šå¯åŠ¨ gRPC æœåŠ¡ï¼š

```go
func main() {
	// å®ä¾‹åŒ– gRPCï¼Œæ³¨å†ŒæœåŠ¡
	s := grpc.NewServer()
	proto.RegisterUserInfoService(s, &userInfoService)

	// ç›‘å¬ç½‘ç»œ
	address := "localhost:8080"
	listener, err := net.Listen("tcp", address)
	if err != nil {
		panic(err)
	}
	fmt.Println("Listening tcp:", address)

	// å¯åŠ¨ gRPC æœåŠ¡
	err = s.Serve(listener)
	if err != nil {
		panic(err)
	}
}
```

### å®¢æˆ·ç«¯å®ç°

å®¢æˆ·ç«¯çš„å®ç°ä¸Šï¼Œå’Œ[æˆ‘ä¸Šä¸€ç¯‡æ–‡ç« ](https://blog.csdn.net/u012419550/article/details/108555316)å†™çš„ç”¨ `net/rpc` å…¶å®å·®åˆ«ä¸å¤§ã€‚

é¦–å…ˆæ˜¯è¿æ¥ç½‘ç»œï¼š

```go
address := "localhost:8080"
clientConn, err := grpc.Dial(address, grpc.WithInsecure())
if err != nil {
    fmt.Println("Dial error:", err)
}
defer clientConn.Close()
```

åˆ©ç”¨ gRPC çš„ `ClientConn`ï¼Œå®ä¾‹åŒ–ä¸€ä¸ªå®¢æˆ·ç«¯ï¼š

```go
client := proto.NewUserInfoClient(clientConn)
```

ï¼ˆè¿™é‡Œçš„ proto è¿˜æ˜¯ä¹‹å‰ protoc ç”Ÿæˆä»£ç çš„é‚£ä¸ªåŒ…ï¼‰

ç„¶åå°±å¯ä»¥è°ƒç”¨æœåŠ¡äº†ï¼Œè¯·æ±‚å‚æ•°æ˜¯ context å’Œä¸€ä¸ª UserRequest å®ä¾‹çš„æŒ‡é’ˆï¼Œè¿”å› UserResponse å’Œ errorï¼š

```go
req := &proto.UserRequest{Name: "foo"}

resp, err := client.GetUserInfo(context.Background(), req)

if err != nil {
    fmt.Println("GetUserInfo error:", err)
}
fmt.Printf("resp: %#v", resp)
```

---

ä»¥ä¸Šä»‹ç»çš„å†…å®¹éƒ½ä½¿ç”¨äº†æœ€æ–°çš„ç‰ˆæœ¬ï¼Œç›¸æ¯”äº Google æœç´¢ `go gRPC æ•™ç¨‹` ç»“æœæ¯”è¾ƒé å‰çš„å‡ ç¯‡ä¸­æ–‡æ–‡ç« ï¼Œè¿™é‡Œä»‹ç»çš„æ–¹æ³•ä» protobuf ç¼–è¯‘åˆ°æœåŠ¡ç«¯å®ç°ä¸Šéƒ½æœ‰ä¸€å®šåŒºåˆ«ã€‚æ–°æ—§ API å„æœ‰ç‰¹è‰²ï¼Œä½†æˆ‘è§‰å¾—éƒ½è¿˜æ˜¯å¾ˆå¥½ç”¨çš„ï¼Œéƒ½æŒºé¡ºæ‰‹ã€‚

P.S. æˆ‘çš„ç¯å¢ƒæ˜¯ `macOS Catalina`ï¼Œ `go 1.12`ï¼Œ`libprotoc 3.13.0`ï¼Œ`protoc-gen-go v1.25.0`ï¼Œ`protoc-gen-go-grpc v0.0.0-20200917190803-0f7e218c2cf4`ã€‚

å®Œæ•´çš„ä»£ç æˆ‘è¿˜æ˜¯æ”¾åˆ°äº† Gist ä¸­ï¼Œéœ€è¦çš„è¯å¯ä»¥è‡ªå–ï¼š

- https://gist.github.com/cdfmlr/95186d2db5e3c510b324e6ad47a76c9b

<script src="https://gist.github.com/cdfmlr/95186d2db5e3c510b324e6ad47a76c9b.js"></script>

```go
By("CDFMLR", "2020-09-18")
log.Println("çœ‹çœ‹ä»Šå¤©çš„æ—¥æœŸï¼Œå†çœ‹çœ‹è¿‘æœŸè¯¸äº‹ï¼Œæˆ‘ä»¬çš„å¼€å‘è€…è¿˜æ˜¯è¦æ›´åŠªåŠ›å•Šã€‚")
// See you.ğŸ’ª
```

